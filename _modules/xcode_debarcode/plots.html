

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>xcode_debarcode.plots &mdash; xcode_debarcode 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/custom.css?v=7d9a6eec" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            xcode_debarcode
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">What is xcode_debarcode?</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/basic_usage.html">Basic Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/method_comparison.html">Method Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/hamming_guidelines.html">Hamming Clustering Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/simulation.html">Simulation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../barcode.html">barcode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../debarcode.html">debarcode</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../io.html">io</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plots.html">plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../postprocessing.html">postprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../preprocessing.html">preprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../simulate.html">simulate</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">xcode_debarcode</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">xcode_debarcode.plots</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for xcode_debarcode.plots</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Interactive visualization functions for debarcoding analysis.&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.graph_objects</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">go</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">plotly.subplots</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_subplots</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">plotly.express</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">px</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">anndata</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ad</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;plot_channel_intensities&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;plot_intensity_scatter&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plot_cumul_barcode_rank&quot;</span>
    <span class="s2">&quot;plot_confidence_distribution&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;plot_hamming_graph&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plot_barcode_rank_histogram&quot;</span><span class="p">,</span>
    <span class="s2">&quot;plot_hamming_heatmap&quot;</span>
<span class="p">]</span>

<div class="viewcode-block" id="plot_intensity_scatter">
<a class="viewcode-back" href="../../plots.html#xcode_debarcode.plots.plot_intensity_scatter">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_intensity_scatter</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
                           <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span><span class="p">,</span>
                           <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">percentile</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">99.0</span><span class="p">,</span>
                           <span class="n">sum_low</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                           <span class="n">sum_high</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">99.0</span><span class="p">,</span>
                           <span class="n">var_low</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                           <span class="n">var_high</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">99.0</span><span class="p">,</span>
                           <span class="n">subsample</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot channel sum vs variance scatter with optional filter preview.</span>
<span class="sd">    </span>
<span class="sd">    Helps visualize cell distribution and preview intensity filtering</span>
<span class="sd">    before applying it.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        Annotated data object with mapped barcode channels.</span>
<span class="sd">    layer : str, optional, default &#39;log&#39;</span>
<span class="sd">        Data layer to use. None for ``adata.X``.</span>
<span class="sd">    method : {&#39;rectangular&#39;, &#39;ellipsoidal&#39;}, optional</span>
<span class="sd">        Filter method to preview. If None, shows raw scatter without filtering.</span>
<span class="sd">    percentile : float, default 99.0</span>
<span class="sd">        For ``&#39;ellipsoidal&#39;`` method, percentile threshold.</span>
<span class="sd">    sum_low : float, optional, default 1.0</span>
<span class="sd">        For ``&#39;rectangular&#39;``: lower percentile bound for channel sum.</span>
<span class="sd">    sum_high : float, optional, default 99.0</span>
<span class="sd">        For ``&#39;rectangular&#39;``: upper percentile bound for channel sum.</span>
<span class="sd">    var_low : float, optional, default 1.0</span>
<span class="sd">        For ``&#39;rectangular&#39;``: lower percentile bound for channel variance.</span>
<span class="sd">    var_high : float, optional, default 99.0</span>
<span class="sd">        For ``&#39;rectangular&#39;``: upper percentile bound for channel variance.</span>
<span class="sd">    subsample : int, optional, default 50000</span>
<span class="sd">        Max cells to plot (for performance). None for all.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Figure</span>
<span class="sd">        Interactive Plotly scatter plot.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;rectangular&#39;</span><span class="p">,</span> <span class="s1">&#39;ellipsoidal&#39;</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;method must be &#39;rectangular&#39;, &#39;ellipsoidal&#39;, or None, got </span><span class="si">{</span><span class="n">method</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;barcode_channels&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Barcode channels not mapped. Run map_channels first.&quot;</span><span class="p">)</span>
    
    <span class="n">bc_channels</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;barcode_channels&#39;</span><span class="p">]</span>
    <span class="n">bc_idx</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">bc_channels</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][:,</span> <span class="n">bc_idx</span><span class="p">]</span> <span class="k">if</span> <span class="n">layer</span> <span class="k">else</span> <span class="n">adata</span><span class="o">.</span><span class="n">X</span><span class="p">[:,</span> <span class="n">bc_idx</span><span class="p">]</span>
    
    <span class="n">channel_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">channel_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">n_total</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    
    <span class="c1"># Subsample for plotting</span>
    <span class="k">if</span> <span class="n">subsample</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">n_total</span> <span class="o">&gt;</span> <span class="n">subsample</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">n_total</span><span class="p">,</span> <span class="n">subsample</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">channel_sum_plot</span> <span class="o">=</span> <span class="n">channel_sum</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">channel_var_plot</span> <span class="o">=</span> <span class="n">channel_var</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">subsampled</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">channel_sum_plot</span> <span class="o">=</span> <span class="n">channel_sum</span>
        <span class="n">channel_var_plot</span> <span class="o">=</span> <span class="n">channel_var</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_total</span><span class="p">)</span>
        <span class="n">subsampled</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Raw scatter</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">channel_sum_plot</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="n">channel_var_plot</span><span class="p">,</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#3498db&#39;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
                <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;Sum: %</span><span class="si">{x:.2f}</span><span class="s1">&lt;br&gt;Var: %</span><span class="si">{y:.4f}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
                <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
        <span class="p">)</span>
        
        <span class="n">subtitle</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">channel_sum_plot</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> cells&quot;</span>
        <span class="k">if</span> <span class="n">subsampled</span><span class="p">:</span>
            <span class="n">subtitle</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (subsampled from </span><span class="si">{</span><span class="n">n_total</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">)&quot;</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Channel Sum vs Variance&lt;br&gt;&lt;sub&gt;</span><span class="si">{</span><span class="n">subtitle</span><span class="si">}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;rectangular&#39;</span><span class="p">:</span>
            <span class="n">thresholds</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;sum_low&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">channel_sum</span><span class="p">,</span> <span class="n">sum_low</span><span class="p">)</span> <span class="k">if</span> <span class="n">sum_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;sum_high&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">channel_sum</span><span class="p">,</span> <span class="n">sum_high</span><span class="p">)</span> <span class="k">if</span> <span class="n">sum_high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;var_low&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">channel_var</span><span class="p">,</span> <span class="n">var_low</span><span class="p">)</span> <span class="k">if</span> <span class="n">var_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;var_high&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">channel_var</span><span class="p">,</span> <span class="n">var_high</span><span class="p">)</span> <span class="k">if</span> <span class="n">var_high</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>
            
            <span class="n">pass_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_total</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;sum_low&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pass_mask</span> <span class="o">&amp;=</span> <span class="n">channel_sum</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;sum_low&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;sum_high&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pass_mask</span> <span class="o">&amp;=</span> <span class="n">channel_sum</span> <span class="o">&lt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;sum_high&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;var_low&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pass_mask</span> <span class="o">&amp;=</span> <span class="n">channel_var</span> <span class="o">&gt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;var_low&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;var_high&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pass_mask</span> <span class="o">&amp;=</span> <span class="n">channel_var</span> <span class="o">&lt;=</span> <span class="n">thresholds</span><span class="p">[</span><span class="s1">&#39;var_high&#39;</span><span class="p">]</span>
            
            <span class="n">param_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;sum=[</span><span class="si">{</span><span class="n">sum_low</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">sum_high</span><span class="si">}</span><span class="s2">], var=[</span><span class="si">{</span><span class="n">var_low</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">var_high</span><span class="si">}</span><span class="s2">]&quot;</span>
        
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># ellipsoidal</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.covariance</span><span class="w"> </span><span class="kn">import</span> <span class="n">MinCovDet</span>
            
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">channel_sum</span><span class="p">,</span> <span class="n">channel_var</span><span class="p">])</span>
            <span class="n">mcd</span> <span class="o">=</span> <span class="n">MinCovDet</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">support_fraction</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
            <span class="n">mcd</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">mahal_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mcd</span><span class="o">.</span><span class="n">mahalanobis</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mahal_dist</span><span class="p">,</span> <span class="n">percentile</span><span class="p">)</span>
            <span class="n">pass_mask</span> <span class="o">=</span> <span class="n">mahal_dist</span> <span class="o">&lt;=</span> <span class="n">threshold</span>
            
            <span class="n">param_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;percentile=</span><span class="si">{</span><span class="n">percentile</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="n">pass_mask_plot</span> <span class="o">=</span> <span class="n">pass_mask</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">fail_mask_plot</span> <span class="o">=</span> <span class="o">~</span><span class="n">pass_mask_plot</span>
        
        <span class="n">n_pass</span> <span class="o">=</span> <span class="n">pass_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">n_fail</span> <span class="o">=</span> <span class="n">n_total</span> <span class="o">-</span> <span class="n">n_pass</span>
        <span class="n">pct_pass</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">n_pass</span> <span class="o">/</span> <span class="n">n_total</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">channel_sum_plot</span><span class="p">[</span><span class="n">fail_mask_plot</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">channel_var_plot</span><span class="p">[</span><span class="n">fail_mask_plot</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#e74c3c&#39;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Removed (</span><span class="si">{</span><span class="n">n_fail</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;Sum: %</span><span class="si">{x:.2f}</span><span class="s1">&lt;br&gt;Var: %</span><span class="si">{y:.4f}</span><span class="s1">&lt;extra&gt;Removed&lt;/extra&gt;&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">channel_sum_plot</span><span class="p">[</span><span class="n">pass_mask_plot</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">channel_var_plot</span><span class="p">[</span><span class="n">pass_mask_plot</span><span class="p">],</span>
                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#3498db&#39;</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Kept (</span><span class="si">{</span><span class="n">n_pass</span><span class="si">:</span><span class="s1">,</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">,</span>
                <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;Sum: %</span><span class="si">{x:.2f}</span><span class="s1">&lt;br&gt;Var: %</span><span class="si">{y:.4f}</span><span class="s1">&lt;extra&gt;Kept&lt;/extra&gt;&#39;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        
        <span class="n">subtitle_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">param_str</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_pass</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_total</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> kept (</span><span class="si">{</span><span class="n">pct_pass</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">subsampled</span><span class="p">:</span>
            <span class="n">subtitle_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;showing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">channel_sum_plot</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Intensity Filter Preview&lt;br&gt;&lt;sub&gt;</span><span class="si">{</span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subtitle_parts</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="p">,</span>
            <span class="n">legend</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">yanchor</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span> <span class="n">xanchor</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.99</span><span class="p">)</span>
        <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Channel Sum&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">title_text</span><span class="o">=</span><span class="s2">&quot;Channel Variance&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="plot_barcode_rank_histogram">
<a class="viewcode-back" href="../../plots.html#xcode_debarcode.plots.plot_barcode_rank_histogram">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_barcode_rank_histogram</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
                                <span class="n">assignment_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">confidence_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
                                <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
                                <span class="n">min_metric</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="n">valid_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot rank histogram of top barcode patterns.</span>
<span class="sd">    </span>
<span class="sd">    Shows the most frequent barcode patterns as a ranked bar chart.</span>
<span class="sd">    Valid patterns shown in blue, invalid patterns in grey.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        Annotated data object.</span>
<span class="sd">    assignment_col : str</span>
<span class="sd">        Column name with barcode assignments (string patterns).</span>
<span class="sd">    confidence_col : str, optional</span>
<span class="sd">        Column name with confidence scores. Required for ``metric=&#39;median_conf&#39;``</span>
<span class="sd">        or ``&#39;score&#39;``.</span>
<span class="sd">    metric : {&#39;count&#39;, &#39;median_conf&#39;, &#39;score&#39;}, default &#39;count&#39;</span>
<span class="sd">        Metric to rank and display.</span>
<span class="sd">    top_n : int, default 20</span>
<span class="sd">        Number of top patterns to show.</span>
<span class="sd">    min_metric : float, default 0</span>
<span class="sd">        Minimum metric value to include pattern.</span>
<span class="sd">    valid_only : bool, default False</span>
<span class="sd">        Only show valid patterns.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Figure</span>
<span class="sd">        Interactive Plotly bar chart.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.barcode</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_valid_pattern</span>
    
    <span class="k">if</span> <span class="n">assignment_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assignment column &#39;</span><span class="si">{</span><span class="n">assignment_col</span><span class="si">}</span><span class="s2">&#39; not found in adata.obs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;median_conf&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metric must be &#39;count&#39;, &#39;median_conf&#39;, or &#39;score&#39;, got </span><span class="si">{</span><span class="n">metric</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;median_conf&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">}</span> <span class="ow">and</span> <span class="n">confidence_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;confidence_col required for metric=&#39;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">confidence_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">confidence_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence column &#39;</span><span class="si">{</span><span class="n">confidence_col</span><span class="si">}</span><span class="s2">&#39; not found in adata.obs&quot;</span><span class="p">)</span>
    
    <span class="n">patterns_str</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">assignment_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">confidences</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">confidence_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_col</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="n">pattern_to_cells</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">patterns_str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pattern_to_cells</span><span class="p">:</span>
            <span class="n">pattern_to_cells</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pattern_to_cells</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    
    <span class="n">pattern_stats</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">pattern_to_cells</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">pattern_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_valid_pattern</span><span class="p">(</span><span class="n">pattern_tuple</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">median_conf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">confidences</span><span class="p">[</span><span class="n">indices</span><span class="p">]))</span> <span class="k">if</span> <span class="n">confidences</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">median_conf</span> <span class="k">if</span> <span class="n">median_conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        
        <span class="n">metric_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span> <span class="s1">&#39;median_conf&#39;</span><span class="p">:</span> <span class="n">median_conf</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">}[</span><span class="n">metric</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">metric_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">metric_value</span> <span class="o">&lt;</span> <span class="n">min_metric</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="n">pattern_stats</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">count</span><span class="p">,</span>
            <span class="s1">&#39;median_conf&#39;</span><span class="p">:</span> <span class="n">median_conf</span><span class="p">,</span>
            <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="n">score</span><span class="p">,</span>
            <span class="s1">&#39;pattern_tuple&#39;</span><span class="p">:</span> <span class="n">pattern_tuple</span>
        <span class="p">}</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_stats</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No patterns with </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2"> &gt;= </span><span class="si">{</span><span class="n">min_metric</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span>
                        <span class="p">(</span><span class="s2">&quot; and valid_only=True&quot;</span> <span class="k">if</span> <span class="n">valid_only</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    
    <span class="c1"># Sort by metric</span>
    <span class="n">top_patterns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pattern_stats</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">metric</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="n">top_n</span><span class="p">]</span>
    
    <span class="n">ranks</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_patterns</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">top_patterns</span><span class="p">]</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">top_patterns</span><span class="p">]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#3498db&#39;</span> <span class="k">if</span> <span class="n">is_valid_pattern</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;pattern_tuple&#39;</span><span class="p">])</span> <span class="k">else</span> <span class="s1">&#39;#95a5a6&#39;</span> 
              <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">stats</span> <span class="ow">in</span> <span class="n">top_patterns</span><span class="p">]</span>
    
    <span class="n">hover_texts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">stats</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">top_patterns</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;pattern_tuple&#39;</span><span class="p">]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rank: </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Pattern: </span><span class="se">{{</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">enumerate</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">&lt;br&gt;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Count: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Valid: </span><span class="si">{</span><span class="n">is_valid_pattern</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median_conf&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;br&gt;Median conf: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;median_conf&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;br&gt;Score: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">hover_texts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">ranks</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">values</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2c3e50&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span>
            <span class="n">customdata</span><span class="o">=</span><span class="n">hover_texts</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;%</span><span class="si">{customdata}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="p">)</span>
    
    <span class="n">metric_labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="s1">&#39;Count&#39;</span><span class="p">,</span>
        <span class="s1">&#39;median_conf&#39;</span><span class="p">:</span> <span class="s1">&#39;Median Confidence&#39;</span><span class="p">,</span>
        <span class="s1">&#39;score&#39;</span><span class="p">:</span> <span class="s1">&#39;Score (count  median_conf)&#39;</span>
    <span class="p">}</span>
    
    <span class="n">subtitle_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Top </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">top_patterns</span><span class="p">)</span><span class="si">}</span><span class="s2"> patterns by </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                      <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> cells&quot;</span><span class="p">,</span>
                      <span class="sa">f</span><span class="s2">&quot;min_</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">min_metric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">valid_only</span><span class="p">:</span>
        <span class="n">subtitle_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;valid only&quot;</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Barcode Pattern Rank Histogram&lt;br&gt;&quot;</span>
              <span class="sa">f</span><span class="s2">&quot;&lt;sub&gt;</span><span class="si">{</span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subtitle_parts</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rank (by </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
            <span class="n">tickmode</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
            <span class="n">tick0</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">dtick</span><span class="o">=</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">top_patterns</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">20</span> <span class="k">else</span> <span class="mi">5</span>
        <span class="p">),</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="n">metric_labels</span><span class="p">[</span><span class="n">metric</span><span class="p">],</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">500</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">plot_cumul_barcode_rank</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
                            <span class="n">assignment_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                            <span class="n">confidence_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;count&#39;</span><span class="p">,</span>
                            <span class="n">valid_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                            <span class="n">log_x</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot cumulative barcode rank curve.</span>
<span class="sd">    </span>
<span class="sd">    Shows cumulative sum of metric values across patterns ranked by that metric.</span>
<span class="sd">    Useful for visualizing how many top patterns capture most of the data.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        Annotated data object.</span>
<span class="sd">    assignment_col : str</span>
<span class="sd">        Column name with barcode assignments (string patterns).</span>
<span class="sd">    confidence_col : str, optional</span>
<span class="sd">        Column name with confidence scores. Required for ``metric=&#39;score&#39;``.</span>
<span class="sd">    metric : {&#39;count&#39;, &#39;score&#39;}, default &#39;count&#39;</span>
<span class="sd">        Metric to rank by: ``&#39;count&#39;`` or ``&#39;score&#39;`` (count * median_conf).</span>
<span class="sd">    valid_only : bool, default False</span>
<span class="sd">        Only include valid patterns.</span>
<span class="sd">    normalize : bool, default True</span>
<span class="sd">        Normalize cumulative sum to [0, 1].</span>
<span class="sd">    log_x : bool, default True</span>
<span class="sd">        Use log scale for x-axis.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Figure</span>
<span class="sd">        Interactive Plotly cumulative rank curve.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.barcode</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_valid_pattern</span>
    
    <span class="k">if</span> <span class="n">assignment_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assignment column &#39;</span><span class="si">{</span><span class="n">assignment_col</span><span class="si">}</span><span class="s2">&#39; not found in adata.obs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;score&#39;</span><span class="p">}:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;metric must be &#39;count&#39; or &#39;score&#39;, got </span><span class="si">{</span><span class="n">metric</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;score&#39;</span> <span class="ow">and</span> <span class="n">confidence_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;confidence_col required for metric=&#39;score&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">confidence_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">confidence_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence column &#39;</span><span class="si">{</span><span class="n">confidence_col</span><span class="si">}</span><span class="s2">&#39; not found in adata.obs&quot;</span><span class="p">)</span>
    
    <span class="n">patterns_str</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">assignment_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
    <span class="n">confidences</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">confidence_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_col</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="n">pattern_to_cells</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">patterns_str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pattern_to_cells</span><span class="p">:</span>
            <span class="n">pattern_to_cells</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pattern_to_cells</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    
    <span class="n">metric_values</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">indices</span> <span class="ow">in</span> <span class="n">pattern_to_cells</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">pattern_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_valid_pattern</span><span class="p">(</span><span class="n">pattern_tuple</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="o">==</span> <span class="s1">&#39;score&#39;</span><span class="p">:</span>
            <span class="n">median_conf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">confidences</span><span class="p">[</span><span class="n">indices</span><span class="p">]))</span>
            <span class="n">metric_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="n">median_conf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metric_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_values</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No patterns found&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; with valid_only=True&quot;</span> <span class="k">if</span> <span class="n">valid_only</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    
    <span class="n">metric_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">metric_values</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="n">cumsum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">metric_values</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">cumsum</span> <span class="o">=</span> <span class="n">cumsum</span> <span class="o">/</span> <span class="n">cumsum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">ranks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_values</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">hover_texts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Rank: </span><span class="si">{</span><span class="n">r</span><span class="si">}</span><span class="s2">&lt;br&gt;</span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&lt;br&gt;Cumulative: </span><span class="si">{</span><span class="n">c</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> 
                   <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">metric_values</span><span class="p">,</span> <span class="n">cumsum</span><span class="p">)]</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">ranks</span><span class="p">,</span>
            <span class="n">y</span><span class="o">=</span><span class="n">cumsum</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#3498db&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">customdata</span><span class="o">=</span><span class="n">hover_texts</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;%</span><span class="si">{customdata}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
            <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="p">)</span>
    
    <span class="n">y_label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Cumulative </span><span class="si">{</span><span class="n">metric</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="s2">&quot; (normalized)&quot;</span> <span class="k">if</span> <span class="n">normalize</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    
    <span class="n">subtitle_parts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">metric_values</span><span class="p">)</span><span class="si">}</span><span class="s2"> patterns&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">valid_only</span><span class="p">:</span>
        <span class="n">subtitle_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;valid only&quot;</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Cumulative Barcode Rank Curve&lt;br&gt;&lt;sub&gt;</span><span class="si">{</span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">subtitle_parts</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="p">,</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Rank (by &quot;</span> <span class="o">+</span> <span class="n">metric</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="n">y_label</span><span class="p">,</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">500</span>
    <span class="p">)</span>
    
    <span class="k">if</span> <span class="n">log_x</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>


<div class="viewcode-block" id="plot_channel_intensities">
<a class="viewcode-back" href="../../plots.html#xcode_debarcode.plots.plot_channel_intensities">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_channel_intensities</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
                         <span class="n">channels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">layer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">show_method_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">log_scale_x</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">log_scale_y</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span>
                         <span class="n">xlim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">xlim_percentile</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot interactive channel intensity distributions.</span>
<span class="sd">    </span>
<span class="sd">    Creates interactive histograms for barcode channel intensities.</span>
<span class="sd">    Can overlay learned parameters from debarcoding methods.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        Annotated data object.</span>
<span class="sd">    channels : list of str, optional</span>
<span class="sd">        Specific channels to visualize. If None, shows all barcode channels.</span>
<span class="sd">    layer : str, optional</span>
<span class="sd">        Layer to use for visualization. If None, uses ``.X`` (raw data).</span>
<span class="sd">        If using a transformed layer (e.g., ``&#39;log&#39;``, ``&#39;arcsinh_cf5&#39;``), </span>
<span class="sd">        set ``log_scale_x=False`` since data is already transformed.</span>
<span class="sd">    show_method_data : str, optional</span>
<span class="sd">        Name of debarcoding result from ``adata.uns[&#39;debarcoding&#39;]`` to visualize.</span>
<span class="sd">        Shows overlays based on the method (GMM means, thresholds, etc.).</span>
<span class="sd">    log_scale_x : bool, default True</span>
<span class="sd">        Use log scale for x-axis. Set to False when using transformed layers.</span>
<span class="sd">    log_scale_y : bool, default False</span>
<span class="sd">        Use log scale for y-axis.</span>
<span class="sd">    bins : int, default 250</span>
<span class="sd">        Number of histogram bins.</span>
<span class="sd">    xlim : tuple, optional</span>
<span class="sd">        X-axis limits as ``(xmin, xmax)``. Supports partial specification</span>
<span class="sd">        with None for automatic limits.</span>
<span class="sd">    xlim_percentile : tuple, default (0.1, 99.9)</span>
<span class="sd">        Percentile range for automatic limits.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Figure</span>
<span class="sd">        Interactive Plotly figure with channel histograms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="kn">from</span><span class="w"> </span><span class="nn">.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_barcode_channels</span>
    <span class="n">barcode_channels</span> <span class="o">=</span> <span class="n">get_barcode_channels</span><span class="p">(</span><span class="n">adata</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">channels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">channels_to_plot</span> <span class="o">=</span> <span class="n">barcode_channels</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">invalid</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">channels</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">barcode_channels</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">invalid</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid channels (not barcode channels): </span><span class="si">{</span><span class="n">invalid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">channels_to_plot</span> <span class="o">=</span> <span class="n">channels</span>
    
    <span class="n">n_channels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">channels_to_plot</span><span class="p">)</span>
    <span class="n">n_cols</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">n_channels</span><span class="p">)</span>
    <span class="n">n_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">n_channels</span> <span class="o">/</span> <span class="n">n_cols</span><span class="p">))</span>
    
    <span class="n">is_transformed</span> <span class="o">=</span> <span class="p">(</span><span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span> <span class="ow">and</span> 
                     <span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">layer</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;arcsinh&#39;</span><span class="p">)))</span>
    
    <span class="k">if</span> <span class="n">is_transformed</span> <span class="ow">and</span> <span class="n">log_scale_x</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Using transformed layer &#39;</span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">&#39; with log_scale_x=True may produce &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;unexpected results. Consider using log_scale_x=False.&quot;</span><span class="p">,</span>
            <span class="ne">UserWarning</span>
        <span class="p">)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">make_subplots</span><span class="p">(</span>
        <span class="n">rows</span><span class="o">=</span><span class="n">n_rows</span><span class="p">,</span>
        <span class="n">cols</span><span class="o">=</span><span class="n">n_cols</span><span class="p">,</span>
        <span class="n">subplot_titles</span><span class="o">=</span><span class="n">channels_to_plot</span><span class="p">,</span>
        <span class="n">vertical_spacing</span><span class="o">=</span><span class="mf">0.12</span><span class="p">,</span>
        <span class="n">horizontal_spacing</span><span class="o">=</span><span class="mf">0.08</span>
    <span class="p">)</span>
    
    <span class="n">method_type</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">channel_params_dict</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">prob_thresh</span> <span class="o">=</span> <span class="mf">0.5</span>
    
    <span class="k">if</span> <span class="n">show_method_data</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;debarcoding&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;No debarcoding metadata found in adata.uns[&#39;debarcoding&#39;]. &quot;</span>
                <span class="s2">&quot;No method overlays will be shown.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">show_method_data</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;debarcoding&#39;</span><span class="p">]:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;debarcoding&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Method &#39;</span><span class="si">{</span><span class="n">show_method_data</span><span class="si">}</span><span class="s2">&#39; not found in adata.uns[&#39;debarcoding&#39;]. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available methods: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">. No method overlays will be shown.&quot;</span><span class="p">,</span>
                <span class="ne">UserWarning</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">method_info</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;debarcoding&#39;</span><span class="p">][</span><span class="n">show_method_data</span><span class="p">]</span>
            <span class="n">base_method</span> <span class="o">=</span> <span class="n">method_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">base_method</span> <span class="o">==</span> <span class="s1">&#39;gmm&#39;</span><span class="p">:</span>
                <span class="n">method_type</span> <span class="o">=</span> <span class="s1">&#39;gmm&#39;</span>
                <span class="n">channel_params_dict</span> <span class="o">=</span> <span class="n">method_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channel_params&#39;</span><span class="p">)</span>
                <span class="n">prob_thresh</span> <span class="o">=</span> <span class="n">method_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;prob_thresh&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">base_method</span> <span class="o">==</span> <span class="s1">&#39;pc_gmm&#39;</span><span class="p">:</span>
                <span class="n">method_type</span> <span class="o">=</span> <span class="s1">&#39;pc_gmm&#39;</span>
                <span class="n">channel_params_dict</span> <span class="o">=</span> <span class="n">method_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channel_params&#39;</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">base_method</span> <span class="o">==</span> <span class="s1">&#39;manual&#39;</span><span class="p">:</span>
                <span class="n">method_type</span> <span class="o">=</span> <span class="s1">&#39;manual&#39;</span>
                <span class="n">channel_params_dict</span> <span class="o">=</span> <span class="n">method_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channel_params&#39;</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">base_method</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
                <span class="n">auto_method_used</span> <span class="o">=</span> <span class="n">method_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auto_method_used&#39;</span><span class="p">,</span> <span class="s1">&#39;pc_gmm&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">auto_method_used</span> <span class="o">==</span> <span class="s1">&#39;pc_gmm&#39;</span><span class="p">:</span>
                    <span class="n">method_type</span> <span class="o">=</span> <span class="s1">&#39;pc_gmm&#39;</span>
                    <span class="n">channel_params_dict</span> <span class="o">=</span> <span class="n">method_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;channel_params&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">auto_method_used</span> <span class="o">==</span> <span class="s1">&#39;scoring&#39;</span><span class="p">:</span>
                    <span class="n">method_type</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">channel_params_dict</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">elif</span> <span class="n">base_method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;premessa&#39;</span><span class="p">,</span> <span class="s1">&#39;scoring&#39;</span><span class="p">]:</span>
                <span class="n">method_type</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">channel_params_dict</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">channel</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">channels_to_plot</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">//</span> <span class="n">n_cols</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">col</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">%</span> <span class="n">n_cols</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="n">channel_idx</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">layer</span><span class="p">][:,</span> <span class="n">channel_idx</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[:,</span> <span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
            
        <span class="n">xmin_auto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">xlim_percentile</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xmax_auto</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">xlim_percentile</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">xlim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xmin</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">xmin_auto</span>
            <span class="n">xmax</span> <span class="o">=</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">xmax_auto</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">xmin_auto</span><span class="p">,</span> <span class="n">xmax_auto</span>
        
        <span class="n">values_in_range</span> <span class="o">=</span> <span class="n">values</span><span class="p">[(</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="n">xmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="n">xmax</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">values_in_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Histogram</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">values_in_range</span><span class="p">,</span>
                <span class="n">nbinsx</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">channel</span><span class="p">,</span>
                <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                    <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#3498db&#39;</span><span class="p">,</span>
                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2c3e50&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;Intensity: %</span><span class="si">{x:.2f}</span><span class="s1">&lt;br&gt;Count: %</span><span class="si">{y}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span>
            <span class="p">),</span>
            <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
            <span class="n">col</span><span class="o">=</span><span class="n">col</span>
        <span class="p">)</span>
        
        <span class="n">counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">values_in_range</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
        
        <span class="c1"># Add method overlays</span>
        <span class="k">if</span> <span class="n">channel_params_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">method_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">channel_idx_in_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">barcode_channels</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">channel_idx_in_params</span><span class="p">)</span> <span class="ow">in</span> <span class="n">channel_params_dict</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">channel_params_dict</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">channel_idx_in_params</span><span class="p">)]</span>
                
                <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                
                <span class="c1"># Show OFF/ON means for GMM and PC-GMM</span>
                <span class="k">if</span> <span class="n">method_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gmm&#39;</span><span class="p">,</span> <span class="s1">&#39;pc_gmm&#39;</span><span class="p">]:</span>
                    <span class="n">mu_off</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mu_off&#39;</span><span class="p">)</span>
                    <span class="n">mu_on</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mu_on&#39;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">mu_off</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xmin</span> <span class="o">&lt;=</span> <span class="n">mu_off</span> <span class="o">&lt;=</span> <span class="n">xmax</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                                <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">mu_off</span><span class="p">,</span> <span class="n">mu_off</span><span class="p">],</span>
                                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span>
                                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#e74c3c&#39;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">&#39;dash&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                                <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;&lt;b&gt;OFF mean&lt;/b&gt;&lt;br&gt;Intensity: %</span><span class="si">{x:.3f}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;OFF&#39;</span>
                            <span class="p">),</span>
                            <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
                            <span class="n">col</span><span class="o">=</span><span class="n">col</span>
                        <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">mu_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xmin</span> <span class="o">&lt;=</span> <span class="n">mu_on</span> <span class="o">&lt;=</span> <span class="n">xmax</span><span class="p">:</span>
                        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                                <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">mu_on</span><span class="p">,</span> <span class="n">mu_on</span><span class="p">],</span>
                                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span>
                                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">&#39;dash&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                                <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;&lt;b&gt;ON mean&lt;/b&gt;&lt;br&gt;Intensity: %</span><span class="si">{x:.3f}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ON&#39;</span>
                            <span class="p">),</span>
                            <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
                            <span class="n">col</span><span class="o">=</span><span class="n">col</span>
                        <span class="p">)</span>
                
                <span class="c1"># Show threshold for GMM and manual </span>
                <span class="k">if</span> <span class="n">method_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gmm&#39;</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">]:</span>
                    <span class="n">threshold</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">xmin</span> <span class="o">&lt;=</span> <span class="n">threshold</span> <span class="o">&lt;=</span> <span class="n">xmax</span><span class="p">:</span>
                        <span class="n">hover_label</span> <span class="o">=</span> <span class="s1">&#39;Threshold&#39;</span> <span class="k">if</span> <span class="n">method_type</span> <span class="o">==</span> <span class="s1">&#39;gmm&#39;</span> <span class="k">else</span> <span class="s1">&#39;Manual Threshold&#39;</span>
                        <span class="n">hover_extra</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39; (p=</span><span class="si">{</span><span class="n">prob_thresh</span><span class="si">}</span><span class="s1">)&#39;</span> <span class="k">if</span> <span class="n">method_type</span> <span class="o">==</span> <span class="s1">&#39;gmm&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
                        
                        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                            <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                                <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">threshold</span><span class="p">,</span> <span class="n">threshold</span><span class="p">],</span>
                                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span>
                                <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                                <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#f39c12&#39;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                                <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">hovertemplate</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;b&gt;</span><span class="si">{</span><span class="n">hover_label</span><span class="si">}</span><span class="s1">&lt;/b&gt;</span><span class="si">{</span><span class="n">hover_extra</span><span class="si">}</span><span class="s1">&lt;br&gt;Intensity: %</span><span class="se">{{</span><span class="s1">x:.3f</span><span class="se">}}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
                                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Threshold&#39;</span>
                            <span class="p">),</span>
                            <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
                            <span class="n">col</span><span class="o">=</span><span class="n">col</span>
                        <span class="p">)</span>
        
        <span class="n">xaxis_type</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span> <span class="k">if</span> <span class="p">(</span><span class="n">log_scale_x</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_transformed</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;linear&#39;</span>
        <span class="n">yaxis_type</span> <span class="o">=</span> <span class="s1">&#39;log&#39;</span> <span class="k">if</span> <span class="n">log_scale_y</span> <span class="k">else</span> <span class="s1">&#39;linear&#39;</span>
        
        <span class="k">if</span> <span class="n">xaxis_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">x_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xmax</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">]</span>
        
        <span class="n">x_title</span> <span class="o">=</span> <span class="s2">&quot;Intensity (log)&quot;</span> <span class="k">if</span> <span class="n">xaxis_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="k">else</span> <span class="s2">&quot;Intensity&quot;</span>
        <span class="n">y_title</span> <span class="o">=</span> <span class="s2">&quot;Count (log)&quot;</span> <span class="k">if</span> <span class="n">yaxis_type</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span> <span class="k">else</span> <span class="s2">&quot;Count&quot;</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span>
            <span class="n">title_text</span><span class="o">=</span><span class="n">x_title</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">xaxis_type</span><span class="p">,</span>
            <span class="nb">range</span><span class="o">=</span><span class="n">x_range</span><span class="p">,</span>
            <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
            <span class="n">col</span><span class="o">=</span><span class="n">col</span>
        <span class="p">)</span>
        
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span>
            <span class="n">title_text</span><span class="o">=</span><span class="n">y_title</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="n">yaxis_type</span><span class="p">,</span>
            <span class="n">row</span><span class="o">=</span><span class="n">row</span><span class="p">,</span>
            <span class="n">col</span><span class="o">=</span><span class="n">col</span>
        <span class="p">)</span>
    
    <span class="n">title_parts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Channel Intensity Distributions&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">layer</span><span class="p">:</span>
        <span class="n">title_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(layer: </span><span class="si">{</span><span class="n">layer</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_method_data</span> <span class="ow">and</span> <span class="n">channel_params_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">title_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">show_method_data</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method_type</span> <span class="o">==</span> <span class="s1">&#39;gmm&#39;</span><span class="p">:</span>
            <span class="n">title_parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">show_method_data</span><span class="si">}</span><span class="s2">: GMM, threshold=</span><span class="si">{</span><span class="n">prob_thresh</span><span class="si">}</span><span class="s2">]&quot;</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title_text</span><span class="o">=</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">title_parts</span><span class="p">),</span>
        <span class="n">title_font_size</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">350</span> <span class="o">*</span> <span class="n">n_rows</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">plot_confidence_distribution</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
                                <span class="n">confidence_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                                <span class="n">show_threshold</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot interactive confidence score distribution.</span>
<span class="sd">    </span>
<span class="sd">    Creates an interactive histogram of confidence scores.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        Annotated data object.</span>
<span class="sd">    confidence_col : str</span>
<span class="sd">        Name of confidence column in ``adata.obs``.</span>
<span class="sd">    bins : int, default 100</span>
<span class="sd">        Number of histogram bins.</span>
<span class="sd">    show_threshold : str, optional</span>
<span class="sd">        Filter name to display threshold line for.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Figure</span>
<span class="sd">        Interactive Plotly histogram.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">confidence_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence column &#39;</span><span class="si">{</span><span class="n">confidence_col</span><span class="si">}</span><span class="s2">&#39; not found in adata.obs&quot;</span><span class="p">)</span>
    
    <span class="n">confidences</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">confidence_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Histogram</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">confidences</span><span class="p">,</span>
            <span class="n">nbinsx</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#1f77b4&#39;</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)),</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;Confidence: %</span><span class="si">{x:.4f}</span><span class="s1">&lt;br&gt;Count: %</span><span class="si">{y}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Confidence&#39;</span>
        <span class="p">)</span>
    <span class="p">)</span>
    
    <span class="n">hist_counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">confidences</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">hist_counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hist_counts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
    
    <span class="k">if</span> <span class="n">show_threshold</span> <span class="ow">and</span> <span class="s1">&#39;confidence_filtering&#39;</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">show_threshold</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;confidence_filtering&#39;</span><span class="p">]:</span>
            <span class="n">filter_info</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;confidence_filtering&#39;</span><span class="p">][</span><span class="n">show_threshold</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">filter_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;confidence_col&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">confidence_col</span><span class="p">:</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="n">filter_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">)</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">filter_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                        <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                            <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">threshold</span><span class="p">,</span> <span class="n">threshold</span><span class="p">],</span>
                            <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span>
                            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#f39c12&#39;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">&#39;dash&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
                            <span class="n">showlegend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">hovertemplate</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;b&gt;</span><span class="si">{</span><span class="n">show_threshold</span><span class="si">}</span><span class="s1">&lt;/b&gt;&lt;br&gt;Method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&lt;br&gt;Threshold: </span><span class="si">{</span><span class="n">threshold</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">show_threshold</span><span class="si">}</span><span class="s1"> (</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">)&#39;</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    
                    <span class="k">if</span> <span class="s1">&#39;gmm_params&#39;</span> <span class="ow">in</span> <span class="n">filter_info</span><span class="p">:</span>
                        <span class="n">gmm_params</span> <span class="o">=</span> <span class="n">filter_info</span><span class="p">[</span><span class="s1">&#39;gmm_params&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;means&#39;</span> <span class="ow">in</span> <span class="n">gmm_params</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmm_params</span><span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">means</span> <span class="o">=</span> <span class="n">gmm_params</span><span class="p">[</span><span class="s1">&#39;means&#39;</span><span class="p">]</span>
                            
                            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                                    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">means</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">means</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span>
                                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#e74c3c&#39;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span>
                                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">hovertemplate</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;b&gt;</span><span class="si">{</span><span class="n">show_threshold</span><span class="si">}</span><span class="s1">&lt;/b&gt;&lt;br&gt;Low mean: </span><span class="si">{</span><span class="n">means</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Low mean&#39;</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            
                            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
                                    <span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">means</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">means</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                    <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span>
                                    <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
                                    <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;#2ca02c&#39;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">&#39;dot&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.5</span><span class="p">),</span>
                                    <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">hovertemplate</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;&lt;b&gt;</span><span class="si">{</span><span class="n">show_threshold</span><span class="si">}</span><span class="s1">&lt;/b&gt;&lt;br&gt;High mean: </span><span class="si">{</span><span class="n">means</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s1">.4f</span><span class="si">}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;High mean&#39;</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Confidence Distribution: </span><span class="si">{</span><span class="n">confidence_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;Confidence Score&quot;</span><span class="p">,</span>
        <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;Count&quot;</span><span class="p">,</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">500</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span>



<div class="viewcode-block" id="plot_hamming_graph">
<a class="viewcode-back" href="../../plots.html#xcode_debarcode.plots.plot_hamming_graph">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_hamming_graph</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
                      <span class="n">assignment_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">confidence_col</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                      <span class="n">min_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                      <span class="n">valid_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">layout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;spring&#39;</span><span class="p">,</span>
                      <span class="n">node_size_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
                      <span class="n">node_size_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">200.0</span><span class="p">,</span>
                      <span class="n">size_transform</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;sqrt&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot interactive Hamming graph of barcode patterns.</span>
<span class="sd">    </span>
<span class="sd">    Creates an interactive network visualization showing barcode patterns</span>
<span class="sd">    connected by Hamming distance. Node size represents pattern frequency,</span>
<span class="sd">    color represents confidence or validity.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        Annotated data object.</span>
<span class="sd">    assignment_col : str</span>
<span class="sd">        Column name with barcode assignments (string patterns).</span>
<span class="sd">    confidence_col : str, optional</span>
<span class="sd">        Column name with confidence scores. If provided, colors nodes by</span>
<span class="sd">        mean confidence. If None, colors by validity (green=valid, red=invalid).</span>
<span class="sd">    radius : int, default 2</span>
<span class="sd">        Exact Hamming distance for edges.</span>
<span class="sd">    min_count : int, default 50</span>
<span class="sd">        Minimum count for patterns to include.</span>
<span class="sd">    valid_only : bool, default True</span>
<span class="sd">        Only show valid patterns.</span>
<span class="sd">    layout : {&#39;spring&#39;, &#39;circular&#39;, &#39;kamada_kawai&#39;}, default &#39;spring&#39;</span>
<span class="sd">        Layout algorithm.</span>
<span class="sd">    node_size_min : float, default 5.0</span>
<span class="sd">        Minimum node size.</span>
<span class="sd">    node_size_max : float, default 200.0</span>
<span class="sd">        Maximum node size.</span>
<span class="sd">    size_transform : {&#39;sqrt&#39;, &#39;log&#39;, &#39;linear&#39;}, default &#39;sqrt&#39;</span>
<span class="sd">        Size transformation for node counts.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Figure</span>
<span class="sd">        Interactive Plotly network graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;networkx is required for Hamming graph visualization. &quot;</span>
            <span class="s2">&quot;Install it with: pip install networkx&quot;</span>
        <span class="p">)</span>
    
    <span class="kn">from</span><span class="w"> </span><span class="nn">.barcode</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_valid_pattern</span>
    
    <span class="k">if</span> <span class="n">assignment_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assignment column &#39;</span><span class="si">{</span><span class="n">assignment_col</span><span class="si">}</span><span class="s2">&#39; not found in adata.obs&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">confidence_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">confidence_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Confidence column &#39;</span><span class="si">{</span><span class="n">confidence_col</span><span class="si">}</span><span class="s2">&#39; not found in adata.obs&quot;</span><span class="p">)</span>
    
    <span class="n">patterns_str</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">assignment_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">confidences</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">confidence_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">confidence_col</span> <span class="k">else</span> <span class="kc">None</span>
    
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>
    <span class="n">pattern_data</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;confidences&#39;</span><span class="p">:</span> <span class="p">[]})</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pattern_str</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">patterns_str</span><span class="p">):</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pattern_str</span><span class="p">)</span>
        <span class="n">pattern_data</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">confidences</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pattern_data</span><span class="p">[</span><span class="n">pattern</span><span class="p">][</span><span class="s1">&#39;confidences&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">confidences</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">valid_only</span><span class="p">:</span>
        <span class="n">pattern_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">d</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">pattern_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">is_valid_pattern</span><span class="p">(</span><span class="n">p</span><span class="p">)}</span>
    
    <span class="n">pattern_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">d</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">pattern_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_count</span><span class="p">}</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern_data</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No patterns found with min_count=</span><span class="si">{</span><span class="n">min_count</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> 
                        <span class="p">(</span><span class="s2">&quot; and valid_only=True&quot;</span> <span class="k">if</span> <span class="n">valid_only</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Building Hamming graph with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">pattern_data</span><span class="p">)</span><span class="si">}</span><span class="s2"> patterns...&quot;</span><span class="p">)</span>
    
    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">pattern_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span>
            <span class="n">pattern</span><span class="p">,</span>
            <span class="n">count</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span>
            <span class="n">valid</span><span class="o">=</span><span class="n">is_valid_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">),</span>
            <span class="n">confidence</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;confidences&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;confidences&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">)</span>
    
    <span class="n">patterns_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pattern_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">patterns_list</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">patterns_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patterns_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">patterns_list</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="o">==</span> <span class="n">radius</span><span class="p">:</span>
                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">patterns_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">patterns_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Nodes: </span><span class="si">{</span><span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span><span class="si">}</span><span class="s2">, Edges: </span><span class="si">{</span><span class="n">G</span><span class="o">.</span><span class="n">number_of_edges</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No nodes in graph after filtering&quot;</span><span class="p">)</span>
    
    <span class="n">n_nodes</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">number_of_nodes</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">layout</span> <span class="o">==</span> <span class="s1">&#39;spring&#39;</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_nodes</span><span class="p">)</span> <span class="k">if</span> <span class="n">n_nodes</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">else</span> <span class="mf">0.5</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">layout</span> <span class="o">==</span> <span class="s1">&#39;circular&#39;</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">circular_layout</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">layout</span> <span class="o">==</span> <span class="s1">&#39;kamada_kawai&#39;</span><span class="p">:</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">kamada_kawai_layout</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown layout: </span><span class="si">{</span><span class="n">layout</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">scale</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_nodes</span><span class="p">)</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">scale</span><span class="p">,</span> <span class="n">y</span> <span class="o">*</span> <span class="n">scale</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">pos</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    
    <span class="n">edge_x</span><span class="p">,</span> <span class="n">edge_y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">():</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">edge_x</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
        <span class="n">edge_y</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span>
    
    <span class="n">edge_trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">edge_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">edge_y</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span>
        <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#888&#39;</span><span class="p">),</span>
        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
        <span class="n">hoverinfo</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()]</span>
    
    <span class="n">transform_fn</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sqrt&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">,</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">,</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">}[</span><span class="n">size_transform</span><span class="p">]</span>
    <span class="n">transformed</span> <span class="o">=</span> <span class="p">[</span><span class="n">transform_fn</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">]</span>
    <span class="n">t_min</span><span class="p">,</span> <span class="n">t_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">transformed</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">transformed</span><span class="p">)</span>
    
    <span class="n">node_x</span><span class="p">,</span> <span class="n">node_y</span><span class="p">,</span> <span class="n">node_sizes</span><span class="p">,</span> <span class="n">node_colors</span><span class="p">,</span> <span class="n">node_borders</span><span class="p">,</span> <span class="n">node_text</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
        <span class="n">node_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">node_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        
        <span class="n">count</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;valid&#39;</span><span class="p">]</span>
        <span class="n">conf</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s1">&#39;confidence&#39;</span><span class="p">]</span>
        
        <span class="n">t</span> <span class="o">=</span> <span class="n">transform_fn</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">node_size_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">t_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">t_max</span> <span class="o">-</span> <span class="n">t_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">node_size_max</span> <span class="o">-</span> <span class="n">node_size_min</span><span class="p">)</span> <span class="k">if</span> <span class="n">t_max</span> <span class="o">&gt;</span> <span class="n">t_min</span> <span class="k">else</span> <span class="p">(</span><span class="n">node_size_min</span> <span class="o">+</span> <span class="n">node_size_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">node_sizes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
        
        <span class="n">node_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">conf</span> <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="s1">&#39;#2ca02c&#39;</span> <span class="k">if</span> <span class="n">valid</span> <span class="k">else</span> <span class="s1">&#39;#d62728&#39;</span><span class="p">))</span>
        <span class="n">node_borders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#000000&#39;</span> <span class="k">if</span> <span class="n">valid</span> <span class="k">else</span> <span class="s1">&#39;#888888&#39;</span><span class="p">)</span>
        
        <span class="n">pattern_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span> <span class="o">==</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">hover</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Pattern: </span><span class="si">{</span><span class="n">pattern_set</span><span class="si">}</span><span class="s2">&lt;br&gt;Count: </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2">&lt;br&gt;Valid: </span><span class="si">{</span><span class="n">valid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">conf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hover</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&lt;br&gt;Mean confidence: </span><span class="si">{</span><span class="n">conf</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">node_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hover</span><span class="p">)</span>
    
    <span class="n">node_trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span>
        <span class="n">x</span><span class="o">=</span><span class="n">node_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">node_y</span><span class="p">,</span>
        <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;markers&#39;</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">size</span><span class="o">=</span><span class="n">node_sizes</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="n">node_colors</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="s1">&#39;RdYlGn&#39;</span> <span class="k">if</span> <span class="n">confidence_col</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">showscale</span><span class="o">=</span><span class="n">confidence_col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mean&lt;br&gt;Confidence&#39;</span><span class="p">,</span> <span class="n">thickness</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="nb">len</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span> <span class="k">if</span> <span class="n">confidence_col</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">node_borders</span><span class="p">),</span>
            <span class="n">cmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">cmax</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">),</span>
        <span class="n">text</span><span class="o">=</span><span class="n">node_text</span><span class="p">,</span>
        <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;%</span><span class="si">{text}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">edge_trace</span><span class="p">,</span> <span class="n">node_trace</span><span class="p">])</span>
    
    <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Hamming Graph (radius=</span><span class="si">{</span><span class="n">radius</span><span class="si">}</span><span class="s2">, min_count=</span><span class="si">{</span><span class="n">min_count</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="k">if</span> <span class="n">valid_only</span><span class="p">:</span>
        <span class="n">title</span> <span class="o">+=</span> <span class="s2">&quot; - Valid patterns only&quot;</span>
    
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
        <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zeroline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">showticklabels</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">height</span><span class="o">=</span><span class="mi">700</span><span class="p">,</span>
        <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span>
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="plot_hamming_heatmap">
<a class="viewcode-back" href="../../plots.html#xcode_debarcode.plots.plot_hamming_heatmap">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">plot_hamming_heatmap</span><span class="p">(</span><span class="n">adata</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span>
                         <span class="n">assignment_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">hamming_radius</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                         <span class="n">valid_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">min_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
                         <span class="n">cluster_patterns</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">use_rank_labels</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot Hamming distance heatmap for barcode patterns.</span>
<span class="sd">    </span>
<span class="sd">    Creates a heatmap showing pairwise Hamming distances between patterns.</span>
<span class="sd">    Patterns can be clustered to group similar patterns together.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    adata : AnnData</span>
<span class="sd">        Annotated data object.</span>
<span class="sd">    assignment_col : str</span>
<span class="sd">        Column name with barcode assignments (string patterns).</span>
<span class="sd">    hamming_radius : int, default 2</span>
<span class="sd">        Maximum Hamming distance to display. Distances &gt; radius shown as white.</span>
<span class="sd">    valid_only : bool, default True</span>
<span class="sd">        Only show valid patterns.</span>
<span class="sd">    min_count : int, default 50</span>
<span class="sd">        Minimum count for patterns to include.</span>
<span class="sd">    cluster_patterns : bool, default True</span>
<span class="sd">        Cluster patterns by Hamming distance.</span>
<span class="sd">    use_rank_labels : bool, default True</span>
<span class="sd">        Use rank numbers (#1, #2, ...) instead of full pattern on axes.</span>
<span class="sd">        Makes heatmap more readable with many patterns.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Figure</span>
<span class="sd">        Interactive Plotly heatmap.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.barcode</span><span class="w"> </span><span class="kn">import</span> <span class="n">is_valid_pattern</span>
    
    <span class="k">if</span> <span class="n">assignment_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Assignment column &#39;</span><span class="si">{</span><span class="n">assignment_col</span><span class="si">}</span><span class="s2">&#39; not found in adata.obs&quot;</span><span class="p">)</span>
    
    <span class="n">patterns_str</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">assignment_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">patterns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns_str</span><span class="p">]</span>
    <span class="n">pattern_counts</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">patterns</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">valid_only</span><span class="p">:</span>
        <span class="n">pattern_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pattern_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">is_valid_pattern</span><span class="p">(</span><span class="n">p</span><span class="p">)}</span>
    
    <span class="n">pattern_counts</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">c</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pattern_counts</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="n">min_count</span><span class="p">}</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern_counts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No patterns found with min_count=</span><span class="si">{</span><span class="n">min_count</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> 
                        <span class="p">(</span><span class="s2">&quot; and valid_only=True&quot;</span> <span class="k">if</span> <span class="n">valid_only</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pattern_counts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need at least 2 patterns for heatmap&quot;</span><span class="p">)</span>
    
    <span class="n">patterns_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">pattern_counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
    <span class="n">pattern_ranks</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">patterns_list</span><span class="p">)}</span>  <span class="c1">#  Store original ranks</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">patterns_list</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing Hamming distance matrix for </span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> patterns...&quot;</span><span class="p">)</span>
    
    <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="k">else</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">patterns_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">patterns_list</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span>
            <span class="n">dist_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span>
    
    <span class="k">if</span> <span class="n">cluster_patterns</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.cluster.hierarchy</span><span class="w"> </span><span class="kn">import</span> <span class="n">linkage</span><span class="p">,</span> <span class="n">leaves_list</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial.distance</span><span class="w"> </span><span class="kn">import</span> <span class="n">squareform</span>
            
            <span class="n">order</span> <span class="o">=</span> <span class="n">leaves_list</span><span class="p">(</span><span class="n">linkage</span><span class="p">(</span><span class="n">squareform</span><span class="p">(</span><span class="n">dist_matrix</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">))</span>
            <span class="n">patterns_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">patterns_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">order</span><span class="p">]</span>
            <span class="n">dist_matrix</span> <span class="o">=</span> <span class="n">dist_matrix</span><span class="p">[</span><span class="n">order</span><span class="p">,</span> <span class="p">:][:,</span> <span class="n">order</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Patterns clustered by hierarchical clustering&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  scipy not available, skipping clustering&quot;</span><span class="p">)</span>
    
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">pattern_ranks</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">use_rank_labels</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;#</span><span class="si">{</span><span class="n">pattern_ranks</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="se">{{</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="nb">enumerate</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="si">}</span><span class="se">}}</span><span class="s2">&quot;</span> 
              <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">patterns_list</span><span class="p">]</span>  
    
    <span class="n">hover</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">pi</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">patterns_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">if</span> <span class="n">b</span><span class="p">}</span>
            <span class="n">pj</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">patterns_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">if</span> <span class="n">b</span><span class="p">}</span>
            <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pattern A (#</span><span class="si">{</span><span class="n">pattern_ranks</span><span class="p">[</span><span class="n">patterns_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">pi</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>  
                <span class="sa">f</span><span class="s2">&quot;Pattern B (#</span><span class="si">{</span><span class="n">pattern_ranks</span><span class="p">[</span><span class="n">patterns_list</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">pj</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>  
                <span class="sa">f</span><span class="s2">&quot;Hamming distance: </span><span class="si">{</span><span class="n">dist_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">]</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Count A: </span><span class="si">{</span><span class="n">pattern_counts</span><span class="p">[</span><span class="n">patterns_list</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="si">}</span><span class="s2">&lt;br&gt;&quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Count B: </span><span class="si">{</span><span class="n">pattern_counts</span><span class="p">[</span><span class="n">patterns_list</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">hover</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    
    <span class="n">display</span> <span class="o">=</span> <span class="n">dist_matrix</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">grey_value</span> <span class="o">=</span> <span class="n">hamming_radius</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">display</span><span class="p">[</span><span class="n">display</span> <span class="o">&gt;</span> <span class="n">hamming_radius</span><span class="p">]</span> <span class="o">=</span> <span class="n">grey_value</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
        <span class="n">go</span><span class="o">.</span><span class="n">Heatmap</span><span class="p">(</span>
            <span class="n">z</span><span class="o">=</span><span class="n">display</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">colorscale</span><span class="o">=</span><span class="p">[</span>
                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;#ffffff&#39;</span><span class="p">],</span> 
                <span class="p">[</span><span class="mf">0.2</span> <span class="o">*</span> <span class="n">hamming_radius</span><span class="o">/</span><span class="n">grey_value</span><span class="p">,</span> <span class="s1">&#39;#e8f4f8&#39;</span><span class="p">],</span> 
                <span class="p">[</span><span class="mf">0.4</span> <span class="o">*</span> <span class="n">hamming_radius</span><span class="o">/</span><span class="n">grey_value</span><span class="p">,</span> <span class="s1">&#39;#a8d8ea&#39;</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.6</span> <span class="o">*</span> <span class="n">hamming_radius</span><span class="o">/</span><span class="n">grey_value</span><span class="p">,</span> <span class="s1">&#39;#6eb5d0&#39;</span><span class="p">],</span> 
                <span class="p">[</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">hamming_radius</span><span class="o">/</span><span class="n">grey_value</span><span class="p">,</span> <span class="s1">&#39;#3d8fb3&#39;</span><span class="p">],</span> 
                <span class="p">[</span><span class="n">hamming_radius</span><span class="o">/</span><span class="n">grey_value</span><span class="p">,</span> <span class="s1">&#39;#1e5a7d&#39;</span><span class="p">],</span>
                <span class="p">[</span><span class="n">hamming_radius</span><span class="o">/</span><span class="n">grey_value</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">,</span> <span class="s1">&#39;#e5ecf6&#39;</span><span class="p">],</span> 
                <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;#e5ecf6&#39;</span><span class="p">]</span>
            <span class="p">],</span>
            <span class="n">zmid</span><span class="o">=</span><span class="n">hamming_radius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">zmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="n">grey_value</span><span class="p">,</span>
            <span class="n">xgap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
            <span class="n">ygap</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  
            <span class="n">text</span><span class="o">=</span><span class="n">hover</span><span class="p">,</span>
            <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;%</span><span class="si">{text}</span><span class="s1">&lt;extra&gt;&lt;/extra&gt;&#39;</span><span class="p">,</span>
            <span class="n">colorbar</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Hamming&lt;br&gt;Distance&quot;</span><span class="p">,</span>
                <span class="n">thickness</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="nb">len</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">tickmode</span><span class="o">=</span><span class="s1">&#39;array&#39;</span><span class="p">,</span>  
                <span class="n">tickvals</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">hamming_radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="n">grey_value</span><span class="p">],</span>  
                <span class="n">ticktext</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">hamming_radius</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Higher&#39;</span><span class="p">]</span> 
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
    
    <span class="n">info</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;max_distance=</span><span class="si">{</span><span class="n">hamming_radius</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">valid_only</span><span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Valid patterns only&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cluster_patterns</span><span class="p">:</span>
        <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Hierarchically clustered&quot;</span><span class="p">)</span>
    <span class="n">info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> patterns, min_count=</span><span class="si">{</span><span class="n">min_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Hamming Distance Heatmap&lt;br&gt;&lt;sub&gt;</span><span class="si">{</span><span class="s1">&#39; | &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="p">)</span><span class="si">}</span><span class="s2">&lt;/sub&gt;&quot;</span><span class="p">,</span>
            <span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">xanchor</span><span class="o">=</span><span class="s1">&#39;center&#39;</span>
        <span class="p">),</span>
        <span class="n">xaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">tickangle</span><span class="o">=-</span><span class="mi">45</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">use_rank_labels</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">),</span>
        <span class="n">yaxis</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">autorange</span><span class="o">=</span><span class="s1">&#39;reversed&#39;</span><span class="p">),</span>
        <span class="n">height</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">30</span><span class="p">),</span>
        <span class="n">width</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="n">n</span> <span class="o">*</span> <span class="mi">30</span><span class="p">),</span>
        <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;closest&#39;</span><span class="p">,</span>
        <span class="n">plot_bgcolor</span><span class="o">=</span><span class="s1">&#39;white&#39;</span> 
    <span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fig</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Marwane Bourdim.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>